{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Verify OTP</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link href="{% static 'vendor/bootstrap/css/bootstrap.min.css' %}" rel="stylesheet">

<style>
body{
  background:linear-gradient(135deg,#fff8e1,#fff3cd);
  font-family:"Segoe UI",system-ui;
}

.otp-wrapper{
  min-height:100vh;
  display:flex;
  justify-content:center;
  align-items:center;
  padding:20px;
}

.otp-card{
  background:#fff;
  width:100%;
  max-width:520px;
  border-radius:18px;
  padding:40px;
  box-shadow:0 20px 50px rgba(0,0,0,.15);
  text-align:center;
}

.otp-boxes{
  display:flex;
  justify-content:space-between;
  gap:10px;
  margin:30px 0;
}

.otp-box{
  width:55px;
  height:65px;
  font-size:28px;
  text-align:center;
  border-radius:12px;
  border:2px solid rgb(225,165,12);
  outline:none;
  font-weight:600;
}

.otp-box:focus{
  box-shadow:0 0 0 3px rgba(225,165,12,.25);
}

.verify-btn{
  height:58px;
  border-radius:14px;
  background:linear-gradient(135deg,rgb(225,165,12),#ffcc33);
  color:white;
  font-weight:700;
  border:none;
  font-size:1.1rem;
}

.shake{
  animation:shake .3s;
}
@keyframes shake{
  0%{transform:translateX(0)}
  25%{transform:translateX(-6px)}
  50%{transform:translateX(6px)}
  75%{transform:translateX(-6px)}
  100%{transform:translateX(0)}
}
</style>
</head>

<body>

<div class="otp-wrapper">
<div class="otp-card">

<h4 class="fw-bold">Verify Your Email</h4>
<p class="text-muted">
We’ve sent a 6-digit OTP to<br>
<strong>{{ email }}</strong>
</p>

<form id="otpForm">
{% csrf_token %}
<input type="hidden" id="email" value="{{ email }}">
<input type="hidden" id="otp">

<div class="otp-boxes" id="otpBoxes">
  <input class="otp-box" maxlength="1">
  <input class="otp-box" maxlength="1">
  <input class="otp-box" maxlength="1">
  <input class="otp-box" maxlength="1">
  <input class="otp-box" maxlength="1">
  <input class="otp-box" maxlength="1">
</div>

<button class="verify-btn w-100">Verify & Continue</button>
</form>

<div id="msg" class="mt-3 fw-semibold"></div>

<div class="mt-4">
Didn’t receive the code?<br>
<button id="resendBtn" class="btn btn-link fw-bold" disabled>
Resend OTP (<span id="timer">30</span>s)
</button>
</div>

</div>
</div>

<script>
function getCookie(name){
 let v=null;
 if(document.cookie){
   document.cookie.split(";").forEach(c=>{
     c=c.trim();
     if(c.startsWith(name+"=")) v=decodeURIComponent(c.substring(name.length+1));
   });
 }
 return v;
}
const csrftoken=getCookie("csrftoken");

const boxes=[...document.querySelectorAll(".otp-box")];
boxes[0].focus();

/* Only digits + move */
boxes.forEach((box,i)=>{
  box.addEventListener("input",()=>{
    box.value=box.value.replace(/[^0-9]/g,"");
    if(box.value && boxes[i+1]) boxes[i+1].focus();
    updateOtp();
  });

  box.addEventListener("keydown",e=>{
    if(e.key==="Backspace" && !box.value && boxes[i-1]){
      boxes[i-1].focus();
    }
  });
});

/* Paste full OTP */
document.getElementById("otpBoxes").addEventListener("paste",e=>{
 e.preventDefault();
 const data=(e.clipboardData||window.clipboardData).getData("text").replace(/\D/g,"").slice(0,6);
 boxes.forEach((b,i)=>b.value=data[i]||"");
 updateOtp();
});

/* Collect OTP */
function updateOtp(){
 const otp=boxes.map(b=>b.value).join("");
 document.getElementById("otp").value=otp;
 if(otp.length===6){
   document.getElementById("otpForm").requestSubmit();
 }
}

/* Submit */
document.getElementById("otpForm").onsubmit=async e=>{
 e.preventDefault();
 const email=document.getElementById("email").value;
 const otp=document.getElementById("otp").value;

 const res=await fetch("{% url 'verify_otp' %}",{
  method:"POST",
  headers:{
    "Content-Type":"application/x-www-form-urlencoded",
    "X-CSRFToken":csrftoken
  },
  body:new URLSearchParams({email,otp})
 });

 const result=await res.json();
 document.getElementById("msg").innerText=result.message;

 if(result.status==="success"){
   setTimeout(()=>window.location.href="/"+result.redirect_url+"/",1000);
 }else{
   document.getElementById("otpBoxes").classList.add("shake");
   setTimeout(()=>document.getElementById("otpBoxes").classList.remove("shake"),300);
 }
};

/* Resend */
let t=30;
const timer=document.getElementById("timer");
const resendBtn=document.getElementById("resendBtn");

function start(){
 resendBtn.disabled=true;
 const i=setInterval(()=>{
  t--;
  timer.innerText=t;
  if(t<=0){
    clearInterval(i);
    resendBtn.disabled=false;
    resendBtn.innerText="Resend OTP";
  }
 },1000);
}
start();

resendBtn.onclick=async()=>{
 resendBtn.disabled=true;
 resendBtn.innerText="Sending...";
 const email=document.getElementById("email").value;

 await fetch("{% url 'resend_otp' %}",{
  method:"POST",
  headers:{
    "Content-Type":"application/x-www-form-urlencoded",
    "X-CSRFToken":csrftoken
  },
  body:new URLSearchParams({email})
 });

 t=30;
 timer.innerText=30;
 resendBtn.innerHTML=`Resend OTP (<span id="timer">30</span>s)`;
 start();
};
</script>

</body>
</html>
